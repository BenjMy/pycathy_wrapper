
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "content/SSHydro/plot_3f_meshing_from_subCatchment.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_content_SSHydro_plot_3f_meshing_from_subCatchment.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_content_SSHydro_plot_3f_meshing_from_subCatchment.py:


Meshing from a Digital Elevation Model (DEM) .adf file
======================================================

*Estimated time to run the notebook = 5min*

.. GENERATED FROM PYTHON SOURCE LINES 10-32

.. code-block:: Python



    # !! run preprocessor change the DEM shape !
    # dtm_13 does not have the same shape anymore!

    import os

    import matplotlib.pyplot as plt
    import numpy as np
    import pandas as pd

    import pyCATHY.meshtools as mt
    from pyCATHY import cathy_tools
    from pyCATHY.importers import cathy_inputs as in_CT
    from pyCATHY.importers import cathy_outputs as out_CT
    from pyCATHY.plotters import cathy_plots as cplt

    import rioxarray
    import pyvista as pv










.. GENERATED FROM PYTHON SOURCE LINES 33-34

------------------------

.. GENERATED FROM PYTHON SOURCE LINES 34-69

.. code-block:: Python

    path2prj = "../SSHydro/"  # add your local path here
    simu = cathy_tools.CATHY(dirName=path2prj,
                             prj_name="meshing_from_subcachment"
                             )

    rootpath = os.path.join(simu.workdir + simu.project_name)


    # Path to the directory containing the .adf file (not the file itself)
    adf_folder = "../../data/dtmplot1/"

    # Open the raster (typically named 'hdr.adf', but you only need the folder)
    raster_DEM = rioxarray.open_rasterio(adf_folder, masked=True).isel(band=0)

    # Create a mask of valid (non-NaN) data
    valid_mask = ~np.isnan(raster_DEM)

    # Apply the mask to get valid coordinates
    valid_x = raster_DEM['x'].where(valid_mask.any(dim='y'), drop=True)
    valid_y = raster_DEM['y'].where(valid_mask.any(dim='x'), drop=True)

    # Get min and max valid coordinates
    min_lon, max_lon = float(valid_x.min()), float(valid_x.max())
    min_lat, max_lat = float(valid_y.min()), float(valid_y.max())

    raster_DEM_masked = raster_DEM.where(
        (raster_DEM['x'] >= min_lon) & (raster_DEM['x'] <= max_lon), drop=True
    ).where(
        (raster_DEM['y'] >= min_lat) & (raster_DEM['y'] <= max_lat), drop=True
    )

    raster_DEM_masked = np.where(np.isnan(raster_DEM_masked), -9999, raster_DEM_masked)
    np.shape(raster_DEM_masked)
    np.shape(raster_DEM)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    ðŸ Initiate CATHY object

    (161, 283)



.. GENERATED FROM PYTHON SOURCE LINES 70-89

.. code-block:: Python


    fig, ax = plt.subplots(1)
    img = ax.imshow(raster_DEM_masked)
    plt.colorbar(img)

    simu.show_input(prop="dem")

    simu.update_prepo_inputs(
        DEM=raster_DEM_masked,
        delta_x=5,
        delta_y=5,
        ivert=1,
    )

    fig = plt.figure()
    ax = plt.axes(projection="3d")
    simu.show_input(prop="dem", ax=ax)
    simu.create_mesh_vtk(verbose=True)




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /content/SSHydro/images/sphx_glr_plot_3f_meshing_from_subCatchment_001.png
         :alt: plot 3f meshing from subCatchment
         :srcset: /content/SSHydro/images/sphx_glr_plot_3f_meshing_from_subCatchment_001.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /content/SSHydro/images/sphx_glr_plot_3f_meshing_from_subCatchment_002.png
         :alt: plot 3f meshing from subCatchment
         :srcset: /content/SSHydro/images/sphx_glr_plot_3f_meshing_from_subCatchment_002.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /content/SSHydro/images/sphx_glr_plot_3f_meshing_from_subCatchment_003.png
         :alt: plot 3f meshing from subCatchment
         :srcset: /content/SSHydro/images/sphx_glr_plot_3f_meshing_from_subCatchment_003.png
         :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    ðŸ”„ Update hap.in file
    ðŸ”„ Update dem_parameters file 
    ðŸ”„ Update dem_parameters file 
    ðŸ”„ Update hap.in file
    ðŸ”„ Update dem_parameters file 
    ðŸ”„ Update dtm_13 file
    ðŸ”„ update zone file 
    ðŸ”„ Update dem_parameters file 
    ðŸ”„ Update parm file 
    ðŸ”„ Update dem_parameters file 
    ðŸ³ gfortran compilation
    ðŸ‘Ÿ Run preprocessor

     wbb...

     searching the dtm_13.val input file...
     assigned nodata value =  -9999.0000000000000     

     number of processed cells =        1174

     ...wbb completed

     rn...
     csort I...
     ...completed

     depit...
     dem modifications =            0
     dem modifications =            0 (total)
     ...completed

     csort II...
     ...completed

     cca...

     contour curvature threshold value =    9.99999996E+11
     ...completed

     smean...
     mean (min,max) facet slope =  0.216937334 ( 0.012000000, 0.760631317)
     ...completed

     dsf...
     weight w_1 less than 1.0E-06: set w_1 = 0 and w_2 = 1
     weight w_1 less than 1.0E-06: set w_1 = 0 and w_2 = 1
     the drainage direction of the outlet cell (           2 ) is used
     ...completed

     hg...
     ...completed

     saving the data in the basin_b/basin_i files...

     ...rn completed

     mrbb...


     Select the header type:
     0) None
     1) ESRI ascii file
     2) GRASS ascii file
     (Ctrl C to exit)

     -> 
     Select the nodata value:
     (Ctrl C to exit)

     -> 
     Select the pointer system:
     1) HAP system
     2) Arc/Gis system
     (Ctrl C to exit)

     ->  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dem file

     min value = 0.567960E+03
     max value = 0.628820E+03
     number of cells =  1174
     mean value = 0.592434E+03

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     lakes_map file

     min value =     0
     max value =     0
     number of cells =  1174
     mean value =     0.000000

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     zone file

     min value =     1
     max value =     1
     number of cells =  1174
     mean value =     1.000000

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_w_1 file

     min value = 0.000000E+00
     max value = 0.100000E+01
     number of cells =  1174
     mean value = 0.558963E+00

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_w_2 file

     min value = 0.000000E+00
     max value = 0.100000E+01
     number of cells =  1174
     mean value = 0.441037E+00

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_p_outflow_1 file

     min value =     2
     max value =     6
     number of cells =  1174
     mean value =     2.272573

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_p_outflow_2 file

     min value =     0
     max value =     9
     number of cells =  1174
     mean value =     1.447189

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     A_inflow file

     min value = 0.000000000000E+00
     max value = 0.293249992721E+05
     number of cells =  1174
     mean value = 0.770825256348E+03

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_local_slope_1 file

     min value =-0.234000E+00
     max value = 0.750000E+00
     number of cells =  1174
     mean value = 0.189089E+00

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_local_slope_2 file

     min value =-0.189505E+00
     max value = 0.692965E+00
     number of cells =  1174
     mean value = 0.173164E+00

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_epl_1 file

     min value = 0.000000E+00
     max value = 0.500000E+01
     number of cells =  1174
     mean value = 0.469762E+01

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_epl_2 file

     min value = 0.000000E+00
     max value = 0.707107E+01
     number of cells =  1174
     mean value = 0.637239E+01

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_kSs1_sf_1 file

     min value = 0.000000E+00
     max value = 0.665000E+02
     number of cells =  1174
     mean value = 0.288060E+02

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_kSs1_sf_2 file

     min value = 0.000000E+00
     max value = 0.665000E+02
     number of cells =  1174
     mean value = 0.274720E+02

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_Ws1_sf file

     min value = 0.000000E+00
     max value = 0.952684E+01
     number of cells =  1174
     mean value = 0.141419E+01

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_Ws1_sf_2 file

     min value = 0.000000E+00
     max value = 0.667605E+01
     number of cells =  1174
     mean value = 0.126586E+01

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_b1_sf file

     min value = 0.000000E+00
     max value = 0.260000E+00
     number of cells =  1174
     mean value = 0.538160E-01

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_y1_sf file

     min value = 0.000000E+00
     max value = 0.000000E+00
     number of cells =  1174
     mean value = 0.000000E+00

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_hcID file

     min value =     0
     max value =     1
     number of cells =  1174
     mean value =     0.206985

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_q_output file

     min value =     0
     max value =     0
     number of cells =  1174
     mean value =     0.000000

     writing the output file...

     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

     dtm_nrc file

     min value = 0.100000E+01
     max value = 0.100000E+02
     number of cells =  1174
     mean value = 0.813714E+01

     writing the output file...

     ...mrbb completed

     bb2shp...

     writing file river_net.shp

    Note: The following floating-point exceptions are signalling: 
    IEEE_UNDERFLOW_FLAG IEEE_DENORMAL

    ðŸ”„ Update parm file 
    ðŸ›   Recompile src files [7s]
    ðŸ³ gfortran compilation [16s]
    âŒ Linker error:
    /usr/bin/ld: cannot find -llapack: No such file or directory
    /usr/bin/ld: cannot find -lblas: No such file or directory
    collect2: error: ld returned 1 exit status

    ðŸ‘Ÿ Run processor
    b''




.. GENERATED FROM PYTHON SOURCE LINES 90-91

meshfile = rootpath + "/vtk/" + simu.project_name + ".vtk"

.. GENERATED FROM PYTHON SOURCE LINES 91-105

.. code-block:: Python


    # mesh2plot = pv.read(meshfile)

    # pl = pv.Plotter(off_screen=True)

    # pl.add_mesh(mesh2plot)
    # pl.show_bounds()

    # pl.show()
    # mesh2plot.plot(show_edges=True,
    #                show_axes=True,
    #                show_bounds=True
    #                )








.. GENERATED FROM PYTHON SOURCE LINES 106-154

.. code-block:: Python


    simu.run_preprocessor(verbose=False)
    # simu.run_processor(IPRT1=3,verbose=True)

    # # simu.read_inputs('atmbc')
    simu.update_parm(TIMPRTi=[1800,7200])

    grid3d = simu.read_outputs('grid3d')

    t_atmbc = [0,86400,86400*4]
    v_atmbc_t_rain = 1e-7
    netValue = np.zeros(len(t_atmbc))
    netValue[0] = v_atmbc_t_rain
    # fig, ax = plt.subplots()
    # ax.imshow(v_atmbc)


    #% Create an empty dataframe of SPP and set default SPP properties
    df_SPP_map = simu.init_soil_SPP_map_df(nzones=1,nstr=15)
    SPP_map = simu.set_SOIL_defaults(SPP_map_default=True)


    SPP_map['PERMX'] = 6.88e-4
    SPP_map['PERMY'] = 6.88e-4
    SPP_map['PERMZ'] = 6.88e-4

    #% Update soil file
    simu.update_soil(SPP_map=SPP_map)


    simu.update_ic(INDP=0,
                   IPOND=0,
                   pressure_head_ini=-15
                      )


    simu.update_atmbc(
                        HSPATM=1,
                        IETO=1,
                        time=t_atmbc,
                        netValue=netValue
                      )

    simu.update_parm(
                            IPRT=4,
                            VTKF=2, # dont write vtk files
                            )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    ðŸ³ gfortran compilation
    ðŸ‘Ÿ Run preprocessor
    ðŸ”„ Update parm file 
    ðŸ”„ Update soil
    homogeneous soil
    ðŸ”„ Update ic
    Single value detected for ic ==> assumming it homogeneous
    ðŸ”„ Update atmbc
    ðŸ”„ Update parm file 
    ðŸ”„ Update parm file 




.. GENERATED FROM PYTHON SOURCE LINES 155-167

.. code-block:: Python


    int(grid3d['nnod'])


    # simu.run_processor(IPRT1=2,
    #                     DTMIN=1e-2,
    #                     DTMAX=1e3,
    #                     DELTAT=1e2,
    #                     TRAFLAG=0,
    #                     verbose=True
    #                     )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    1271



.. GENERATED FROM PYTHON SOURCE LINES 168-182

.. code-block:: Python



    # # pl = pv.Plotter(notebook=True)
    # pl = pv.Plotter(off_screen=True)



    # cplt.show_vtk(unit="pressure",
    #               timeStep=1,
    #               path=simu.workdir + "/meshing_from_subcachment/vtk/",
    #               ax=pl,
    #               )
    # # pl.show()
    # image = pl.screenshot('test.png')








.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 24.491 seconds)


.. _sphx_glr_download_content_SSHydro_plot_3f_meshing_from_subCatchment.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_3f_meshing_from_subCatchment.ipynb <plot_3f_meshing_from_subCatchment.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_3f_meshing_from_subCatchment.py <plot_3f_meshing_from_subCatchment.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: plot_3f_meshing_from_subCatchment.zip <plot_3f_meshing_from_subCatchment.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
