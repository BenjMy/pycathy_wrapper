
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "content/DA/plot_1_DA_NoUni_ic.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_content_DA_plot_1_DA_NoUni_ic.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_content_DA_plot_1_DA_NoUni_ic.py:


DA with Random Initial Conditions on Soil Layers
============================================

This notebook demonstrates how to create an ensemble of models with varying initial conditions for different soil layers. By introducing randomness into the initial conditions, we can better simulate the natural variability in soil properties and improve the robustness of data assimilation (DA) processes.

*Estimated time to run the notebook = 2min*

.. GENERATED FROM PYTHON SOURCE LINES 10-20

.. code-block:: Python


    import os
    import numpy as np
    import pyvista as pv
    from pyCATHY.DA.perturbate import perturbate_parm
    from pyCATHY.DA import perturbate
    from pyCATHY.DA.cathy_DA import DA
    from pyCATHY.plotters import cathy_plots as CTp









.. GENERATED FROM PYTHON SOURCE LINES 21-22

-----------------------

.. GENERATED FROM PYTHON SOURCE LINES 22-40

.. code-block:: Python

    nlay = 6
    scenario = {
                'per_name':['ic'],
                # 'per_type': [[None]*nlay],
                'per_type': [['multiplicative']*nlay],
                'per_nom':[[-15]*nlay],
                # 'per_mean':[[-15]*nlay],
                'per_mean':[[1]*nlay],
                'per_sigma': [[3.75]*nlay],
                'per_bounds': [[None]*nlay],
                'sampling_type': [['normal']*nlay],
                'transf_type':[[None]*nlay],
                'listUpdateParm': ['St. var.'],
                'pert_control_name': ['layers']*nlay
                }










.. GENERATED FROM PYTHON SOURCE LINES 41-42

-----------------------

.. GENERATED FROM PYTHON SOURCE LINES 42-59

.. code-block:: Python

    simuWithDA = DA(
                            dirName='./',
                            prj_name= 'DA_with_non_uniform_ic',
                            notebook=True,
                        )

    # linear z depth
    # ---------------
    zb = np.linspace(0, 2, nlay)
    nstr = len(zb)
    zr = list(np.ones(len(zb))/nstr)

    simuWithDA.update_prepo_inputs(
                                    nstr=nstr,
                                    zratio=zr,
                                    base=max(zb),
                                    )




.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    üèÅ Initiate CATHY object
    üîÑ Update hap.in file
    üîÑ Update dem_parameters file 
    üîÑ Update dem_parameters file 




.. GENERATED FROM PYTHON SOURCE LINES 60-61

----------------------------------------------------------

.. GENERATED FROM PYTHON SOURCE LINES 61-65

.. code-block:: Python

    simuWithDA.update_dem_parameters()
    simuWithDA.update_veg_map()
    simuWithDA.update_soil()





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    üîÑ Update dem_parameters file 
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚ö† warning messages above ‚ö† ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

                                The parm dictionnary is empty
                                Falling back to defaults to update CATHYH
                                This can have consequences !!
                            
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    üîÑ Update parm file 
    üîÑ Update soil
    homogeneous soil




.. GENERATED FROM PYTHON SOURCE LINES 66-67

------------------------------------------

.. GENERATED FROM PYTHON SOURCE LINES 67-92

.. code-block:: Python


    simuWithDA.NENS = 3
    list_pert = perturbate.perturbate(
                                        simuWithDA,
                                        scenario,
                                        simuWithDA.NENS,
                                     )

    var_per_dict_stacked = {}
    for dp in list_pert:
        var_per_dict_stacked = perturbate_parm(
                                    var_per_dict_stacked,
                                    parm=dp,
                                    type_parm = dp['type_parm'], # can also be VAN GENUCHTEN PARAMETERS
                                    mean =  dp['mean'],
                                    sd =  dp['sd'],
                                    sampling_type =  dp['sampling_type'],
                                    ensemble_size =  dp['ensemble_size'], # size of the ensemble
                                    per_type= dp['per_type'],
                                    nlayers = nlay,
                                    savefig= os.path.join(simuWithDA.workdir,
                                                          simuWithDA.project_name,
                                                          simuWithDA.project_name + dp['savefig'])
                                    )




.. rst-class:: sphx-glr-horizontal


    *

      .. image-sg:: /content/DA/images/sphx_glr_plot_1_DA_NoUni_ic_001.png
         :alt: Histogram of ic0
         :srcset: /content/DA/images/sphx_glr_plot_1_DA_NoUni_ic_001.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /content/DA/images/sphx_glr_plot_1_DA_NoUni_ic_002.png
         :alt: Histogram of ic1
         :srcset: /content/DA/images/sphx_glr_plot_1_DA_NoUni_ic_002.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /content/DA/images/sphx_glr_plot_1_DA_NoUni_ic_003.png
         :alt: Histogram of ic2
         :srcset: /content/DA/images/sphx_glr_plot_1_DA_NoUni_ic_003.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /content/DA/images/sphx_glr_plot_1_DA_NoUni_ic_004.png
         :alt: Histogram of ic3
         :srcset: /content/DA/images/sphx_glr_plot_1_DA_NoUni_ic_004.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /content/DA/images/sphx_glr_plot_1_DA_NoUni_ic_005.png
         :alt: Histogram of ic4
         :srcset: /content/DA/images/sphx_glr_plot_1_DA_NoUni_ic_005.png
         :class: sphx-glr-multi-img

    *

      .. image-sg:: /content/DA/images/sphx_glr_plot_1_DA_NoUni_ic_006.png
         :alt: Histogram of ic5
         :srcset: /content/DA/images/sphx_glr_plot_1_DA_NoUni_ic_006.png
         :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /opt/hostedtoolcache/Python/3.10.19/x64/lib/python3.10/site-packages/scipy/stats/_qmc.py:993: UserWarning: The balance properties of Sobol' points require n to be a power of 2.
      sample = self._random(n, workers=workers)




.. GENERATED FROM PYTHON SOURCE LINES 93-94

This in normally directly called when using run_DA_sequential()

.. GENERATED FROM PYTHON SOURCE LINES 94-101

.. code-block:: Python


    simuWithDA.ens_valid =  list(np.arange(0, simuWithDA.NENS))
    simuWithDA._create_subfolders_ensemble()
    simuWithDA.apply_ensemble_updates(var_per_dict_stacked,
                                      var_per_dict_stacked.keys(),
                                      cycle_nb=0
                                      )


.. rst-class:: sphx-glr-script-out

.. code-block:: pytb

    Traceback (most recent call last):
      File "/home/runner/work/pycathy_wrapper/pycathy_wrapper/examples/DA/plot_1_DA_NoUni_ic.py", line 97, in <module>
        simuWithDA.apply_ensemble_updates(var_per_dict_stacked,
      File "/home/runner/work/pycathy_wrapper/pycathy_wrapper/pyCATHY/DA/cathy_DA.py", line 2151, in apply_ensemble_updates
        ic_nodes = self.map_prop_2mesh_markers('ic',
      File "/home/runner/work/pycathy_wrapper/pycathy_wrapper/pyCATHY/cathy_tools.py", line 3699, in map_prop_2mesh_markers
        mt.add_markers_zone3d_2_mesh(
      File "/home/runner/work/pycathy_wrapper/pycathy_wrapper/pyCATHY/meshtools.py", line 932, in add_markers_zone3d_2_mesh
        _find_nearest_point2DEM(
      File "/home/runner/work/pycathy_wrapper/pycathy_wrapper/pyCATHY/meshtools.py", line 874, in _find_nearest_point2DEM
        mesh_pv_attributes.save(saveMeshPath,binary=False)
      File "/opt/hostedtoolcache/Python/3.10.19/x64/lib/python3.10/site-packages/pyvista/_deprecate_positional_args.py", line 248, in inner_f
        return f(*args, **kwargs)
      File "/opt/hostedtoolcache/Python/3.10.19/x64/lib/python3.10/site-packages/pyvista/core/dataobject.py", line 213, in save
        raise FileNotFoundError(msg)
    FileNotFoundError: Parent directory does not exist: /home/runner/work/pycathy_wrapper/pycathy_wrapper/examples/DA/DA_with_non_uniform_ic/DA_Ensemble/cathy_1/vtk




.. GENERATED FROM PYTHON SOURCE LINES 102-103

-----------------------

.. GENERATED FROM PYTHON SOURCE LINES 103-124

.. code-block:: Python


    pl = pv.Plotter(shape=(1,2))
    for i, ensi in enumerate([1,3]):
        DApath = f'DA_Ensemble/cathy_{ensi}/vtk/'
        path = os.path.join(simuWithDA.workdir,
                            simuWithDA.project_name,
                            DApath,
                            simuWithDA.project_name + '.vtk'
                            )

        pl.subplot(0,i)
        CTp.show_vtk(path,
                     'ic_nodes',
                     ax=pl,
                     clim = [-25,-5],
                     #show_scalar_bar=True,
                     )
        _ = pl.add_legend('')
        pl.add_title(f'Ensemble nb:{ensi}')

    pl.show()


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 18.064 seconds)


.. _sphx_glr_download_content_DA_plot_1_DA_NoUni_ic.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_1_DA_NoUni_ic.ipynb <plot_1_DA_NoUni_ic.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_1_DA_NoUni_ic.py <plot_1_DA_NoUni_ic.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: plot_1_DA_NoUni_ic.zip <plot_1_DA_NoUni_ic.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
